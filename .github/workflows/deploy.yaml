name: Build & Deploy

on:
  push:
    branches:
      - master

env:
  REGISTRY_NAME: gielniakcontainerregistry.azurecr.io
  IMAGE_NAME: fastapi-test
  TF_DIR: ./terraform

jobs:
  build:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Check variables
        run: echo ${{ vars.REGISTRY_NAME }} ${{ vars.IMAGE_NAME }} ${{ vars.TF_DIR }}

      - name: Log in to ACR
        run: az acr login --name ${{ vars.REGISTRY_NAME }}

      - name: Set image tag
        id: set-tag
        run: echo "image-tag=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push image
        run: |
          ls
          cd backend
          docker build -t ${{ vars.REGISTRY_NAME }}/${{ vars.IMAGE_NAME }}:${{ steps.set-tag.outputs.image-tag }} .
          docker push ${{ vars.REGISTRY_NAME }}/${{ vars.IMAGE_NAME }}:${{ steps.set-tag.outputs.image-tag }}
    outputs:
      image-tag: ${{ steps.set-tag.outputs.image-tag }}

  deploy-dev:
    needs: build
    uses: ./.github/workflows/deploy-template.yml
    with:
      environment: dev
      image_tag: ${{ needs.build.outputs.image-tag }}
      registry_name: ${{ vars.REGISTRY_NAME }}
      image_name: ${{ vars.IMAGE_NAME }}
      tf_dir: ${{ vars.TF_DIR }}

  deploy-staging:
    needs: [build, deploy-dev]
    uses: ./.github/workflows/deploy-template.yml
    with:
      environment: staging
      image_tag: ${{ needs.build.outputs.image-tag }}
      registry_name: ${{ vars.REGISTRY_NAME }}
      image_name: ${{ vars.IMAGE_NAME }}
      tf_dir: ${{ vars.TF_DIR }}

  deploy-prod:
    needs: [build, deploy-staging]
    uses: ./.github/workflows/deploy-template.yml
    with:
      environment: prod
      image_tag: ${{ needs.build.outputs.image-tag }}
      registry_name: ${{ vars.REGISTRY_NAME }}
      image_name: ${{ vars.IMAGE_NAME }}
      tf_dir: ${{ vars.TF_DIR }}
  
# ad dcomment